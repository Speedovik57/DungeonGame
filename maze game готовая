// MazeGame.cpp : Этот файл содержит функцию "main". Здесь начинается и заканчивается выполнение программы.
//

#include <iostream>
#include <conio.h>
#include "time.h"
#include "windows.h"
#include "CrtLib.h"

using namespace std;
using namespace crt;

const int LX = 75;
const int LY = 30;

const char player = (char)1;
// 0 - пустое пространство
// 1 - стена
// 2 - выход
// 3 - игрок
// 4 - монета
// 5 - алмаз
// 6 - время
// 7 - мина
// 8 - мина2

int maze[LY][LX] = {
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,6,1,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,1,1,1,1},
{1,1,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,1,1,1,1,1,1,1,1,1,1,0,1,1,4,0,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,5,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1},
{1,1,4,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0,0,4,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,7,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,4,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,4,0,0,0,1,1,1,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,1,1,0,1,1,1,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1},
{1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,8,0,1,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,0,0,0,4,0,0,0,0,0,0,0,0,0,1,1,1,1,1},
{1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0,1,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,0,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,0,0,0,0,0,0,1,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,0,0,0,0,0,8,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,3,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
};


// глобальные переменные
int hx, hy; // позиция игрока в лабиринте
int score = 0; // счет игры

int gameState = 0; // 0 - игра продолжается, 1 - выигрыш, 2 - закончилось время
int timeLimit = 200; // лимит игры в секундах
int gameTime; // оставшееся время

clock_t tstart; // значение счетчика таймера при старте игры

// Функция обновляет текущий счет на экране
void UpdateScore(int score)
{
	SetTextColor(COLOR_BLUE);
	GotoXY(35, 30); // ставим курсор на последнюю строку консоли
	setlocale(LC_ALL, "ru-RU"); // включаем локаль, ориентированную на кириллицу
	cout << "СЧЕТ: " << score; // выводим счет на экран
	setlocale(LC_ALL, "C"); // возвращаем настройки локали по умолчанию
}

// Функция обновляет оставшееся время до окончания игры
// параметр t функции - это текущее значение системного таймера, на момент вызова функции
void UpdateClock(clock_t t)
{
	gameTime = timeLimit - (t - tstart) / CLOCKS_PER_SEC; /* вычисляем оставшееся время в секундах
	и помещаем результат в gameTime. (t-tstart) - кол-во миллисекунд, прошедшее
	с момента старта игры. CLOCKS_PER_SEC - константа, определяющая количество
	изменений системного таймера за 1 секунду. Для Windows это значение
	равно 1000. Вычитая из timeLimit время, прошедшее с начала игры, мы вычисляем
	остаток времени в секундах */
	crt::SetTextColor(COLOR_LIGHT_GREEN);
	if (gameTime <= 15)
	{
		crt::SetTextColor(COLOR_LIGHT_RED);
	}
	setlocale(LC_ALL, "ru-RU"); // переключаем локаль
	if (gameTime < 0) // проверяем, закончилось ли время
	{
		gameState = 2; // если да, то обновляем статус игры на 2 - игрок ПРОИГРАЛ
	}
	else
	{ // если время осталось
		GotoXY(49, 30); // ставим курсор на последнюю строку
		cout << "Осталось: " << gameTime << " секунд "; // выводим остаток времени в консоль
	}
	setlocale(LC_ALL, "C"); // восстанавливаем настройки локали
}


// Функция печатает в консоли лабиринт
void PrintMaze(int maze[LY][LX], int sizeX, int sizeY)
{
	for (int i = 0; i < sizeY; i++)
	{
		for (int j = 0; j < sizeX; j++)
		{
			switch (maze[i][j])
			{
			case 0:
				SetTextColor(COLOR_WHITE);
				cout << ' ';
				break;
			case 1:
				SetTextColor(COLOR_RED);
				cout << (char)178;
				break;
			case 2:
				cout << (char)176;
				break;
			case 3:
				SetTextColor(COLOR_WHITE);
				cout << player;
				break;
			case 4:
				SetTextColor(COLOR_YELLOW);
				cout << '$';
				break;
			default:
				cout << '?';
			case 5:
				SetTextColor(COLOR_BLUE);
				cout << (char)4;
				break;
			case 6:
				SetTextColor(COLOR_GREEN);
				cout << (char)30;
				break;
			case 7:
				SetTextColor(COLOR_DARK_GRAY);
				cout << (char)15;
				break;
			case 8:
				SetTextColor(COLOR_DARK_GRAY);
				cout << (char)15;
				break;

			}
		}
		cout << endl;
	}
}

/// Функция определяет валидацию лабиринта
bool FindFirstPlayerPosition(int maze[LY][LX], int sizeX, int sizeY)
{
	int player = 0, finish = 0;
	for (int i = 0; i < sizeY; i++)  // цикл пробегает массив по строкам
	{
		for (int j = 0; j < sizeX; j++) // цикл пробегает массив по столбцам
		{
			if (maze[i][j] == 3)    // проверяем, если текущий элемент равен 3 - нашли
			{                       // требуемую позицию
				player++;
				hx = j;             // записываем столбец в hx
				hy = i;             // записываем строку в h
			}
			if (maze[i][j] == 3)
			{
				finish++;
			}
		}
	}
	if (player == 1 && finish >= 1)
		return true;
	else
		return false;
}
//Функция скрывает игрока с экрана и убирает его из лабиринта
void HidePlayer()
{
	maze[hy][hx] = 0; // записываем в текущую позицию матрицы число 0
	GotoXY(hx, hy); // устанавливаем курсор в позицию игрока в консоль
	cout << ' '; // и печатаем пробел
}

// функция показывает на экране игрока и записывает его в лабиринт
void ShowPlayer()
{
	SetTextColor(COLOR_WHITE);
	maze[hy][hx] = 3; // записываем в текущую позицию матрицы число 0
	GotoXY(hx, hy); // устанавливаем курсор в позицию игрока в консоль
	cout << player; // и печатаем образ игрока
}

void MovePlayer(int dx, int dy, int& hx, int& hy)
{
	if (hx + dx < LX && hy + dy < LY && hx + dx >= 0 && hy + dy >= 0)
	{
		switch (maze[hy + dy][hx + dx])
		{
		case 0:
			HidePlayer();
			hy += dy;
			hx += dx;
			ShowPlayer();
			break;
		case 2:
			HidePlayer();
			hy += dy;
			hx += dx;
			ShowPlayer();
			UpdateScore(score += 500);
			gameState = 1;
			break;
		case 4:
			HidePlayer();
			hy += dy;
			hx += dx;
			ShowPlayer();
			UpdateScore(score += 100);
			break;
		case 5:
			HidePlayer();
			hy += dy;
			hx += dx;
			ShowPlayer();
			UpdateScore(score += 300);
			break;
		case 6:
			HidePlayer();
			hy += dy;
			hx += dx;
			ShowPlayer();
			timeLimit += 10;
			break;
		case 7:
			HidePlayer();
			hy += dy;
			hx += dx;
			ShowPlayer();
			UpdateScore(score -= 200);
			break;
		case 8:
			HidePlayer();
			hy += dy;
			hx += dx;
			ShowPlayer();
			timeLimit -= 8;
			break;
		}
	}
}

void ShowOverMessage()
{
	setlocale(LC_ALL, "ru-RU");
	if (gameState == 1)
	{
		SetTextColor(COLOR_CYAN);
		cout << endl;
		GotoXY(20, 15);
		cout << "вы прошли игру и набрали " << score << " баллов!!!";
	}
	else if (gameState == 2)
	{
		SetTextColor(COLOR_CYAN);
		cout << endl;
		GotoXY(27, 15);
		cout << "вы не успели пройти игру";
	}
	while (_getch() != 27);
}

// Функция обрабатывает события клавиатуры и управляет игрой
void Control()
{
	tstart = clock(); // запоминаем счетчик системного таймера в момент старта игры.
	UpdateScore(score); // обновляем счет игры, изначально он нулевой
	unsigned char x; // это переменная хранит символ, соответствующий нажатой клавише
	while (gameState == 0) // цикл игры - пока gameState == 0, игра идет
	{
		UpdateClock(clock()); // обновляем оставшееся время
		if (_kbhit()) // если была нажата клавиша - то обрабатываем ее, иначе следующая
		{ // итерация игрового цикла
			x = _getch(); // считываем символ нажатой клавиш,
			if (x == 27) return;// если это символ Esc (27) то это выход из игры
			if (x == 0xe0) // если это символ с кодом 0xE0 (шестнадцатеричное)
				switch (_getch()) // то считываем еще один символ (некоторые клавиши выдают двойные коды)
				{
				case 72:          // если 2-й символ код 72, то это клавиша курсор вверх
					MovePlayer(0, -1, hx, hy);       // идем вверх
					break;
				case 80:          // если 2-й символ код 80, то это клавиша курсор вниз
					MovePlayer(0, 1, hx, hy);   // идем вниз
					break;
				case 75:        // если 2-й символ код 75, то это клавиша курсор влево
					MovePlayer(-1, 0, hx, hy);   // идем влево
					break;
				case 77:
					MovePlayer(1, 0, hx, hy);  // если 2 - й символ код 77, то это клавиша курсор вправо
					break;      // идем вправо
				}
		}
		Sleep(200); // останавливаем игру на 200 мсек, если этого не делать, то
	}
	ShowOverMessage();
	// обновление игры будет слишком быстрым, мы не сможем управлять
} // игроком, а также напрасно нагрузим процессор ненужной работой

// Функция main, которая выполняется при запуске прграммы
int main()
{
	system("mode con cols=80 lines=31");
	system("cls");
	PrintMaze(maze, LX, LY);
	FindFirstPlayerPosition(maze, LX, LY);
	HideCursor();
	Control();
	ShowCursor();
}
